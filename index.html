<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>Construction Project Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      /* Tailwind CSS Base */
      *,
      ::before,
      ::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overscroll-behavior: none;
      }

      /* Tailwind CSS Utilities (Subset for this app) */
      .bg-gray-100 {
        background-color: #f3f4f6;
      }
      .bg-gray-50 {
        background-color: #f9fafb;
      }
      .bg-gray-200 {
        background-color: #e5e7eb;
      }
      .bg-white {
        background-color: #ffffff;
      }
      .bg-blue-500 {
        background-color: #3b82f6;
      }
      .bg-blue-600 {
        background-color: #2563eb;
      }
      .bg-green-500 {
        background-color: #22c55e;
      }
      .bg-green-600 {
        background-color: #16a34a;
      }
      .bg-yellow-500 {
        background-color: #f59e0b;
      }
      .bg-yellow-600 {
        background-color: #d97706;
      }
      .bg-red-500 {
        background-color: #ef4444;
      }
      .bg-red-600 {
        background-color: #dc2626;
      }
      .text-white {
        color: #ffffff;
      }
      .text-red-500 {
        color: #ef4444;
      }
      .text-3xl {
        font-size: 1.875rem;
        line-height: 2.25rem;
      }
      .text-2xl {
        font-size: 1.5rem;
        line-height: 2rem;
      }
      .text-xl {
        font-size: 1.25rem;
        line-height: 1.75rem;
      }
      .text-base {
        font-size: 1rem;
        line-height: 1.5rem;
      }
      .font-bold {
        font-weight: 700;
      }
      .font-semibold {
        font-weight: 600;
      }
      .min-h-screen {
        min-height: 100vh;
      }
      .container {
        width: 100%;
        max-width: 1280px;
        margin-left: auto;
        margin-right: auto;
      }
      .p-4 {
        padding: 1rem;
      }
      .p-2 {
        padding: 0.5rem;
      }
      .p-1 {
        padding: 0.25rem;
      }
      .px-2 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      .py-2 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .py-3 {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
      .pl-5 {
        padding-left: 1.25rem;
      }
      .mx-auto {
        margin-left: auto;
        margin-right: auto;
      }
      .mb-6 {
        margin-bottom: 1.5rem;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .mt-4 {
        margin-top: 1rem;
      }
      .mt-2 {
        margin-top: 0.5rem;
      }
      .mr-2 {
        margin-right: 0.5rem;
      }
      .ml-2 {
        margin-left: 0.5rem;
      }
      .rounded {
        border-radius: 0.25rem;
      }
      .rounded-lg {
        border-radius: 0.5rem;
      }
      .border {
        border-width: 1px;
        border-color: #e5e7eb;
      }
      .shadow-md {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
      .grid {
        display: grid;
      }
      .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .gap-4 {
        gap: 1rem;
      }
      .gap-2 {
        gap: 0.5rem;
      }
      .text-center {
        text-align: center;
      }
      .flex {
        display: flex;
      }
      .items-center {
        align-items: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .flex-col {
        flex-direction: column;
      }
      .list-disc {
        list-style-type: disc;
      }
      .w-full {
        width: 100%;
      }
      .min-w-\[2rem\] {
        min-width: 2rem;
      }
      .min-h-\[44px\] {
        min-height: 44px;
      }
      .border-collapse {
        border-collapse: collapse;
      }
      .overflow-x-auto {
        overflow-x: auto;
      }
      .touch-manipulation {
        touch-action: manipulation;
      }
      .hover\:bg-blue-600:hover {
        background-color: #2563eb;
      }
      .hover\:bg-green-600:hover {
        background-color: #16a34a;
      }
      .hover\:bg-yellow-600:hover {
        background-color: #d97706;
      }
      .hover\:bg-red-600:hover {
        background-color: #dc2626;
      }

      /* Enhanced Mobile Responsiveness */
      @media (max-width: 640px) {
        .container {
          padding: 0.5rem;
        }
        .text-3xl {
          font-size: 1.5rem;
          line-height: 2rem;
        }
        .text-2xl {
          font-size: 1.25rem;
          line-height: 1.75rem;
        }
        .text-xl {
          font-size: 1rem;
          line-height: 1.5rem;
        }
        .text-base {
          font-size: 0.875rem;
          line-height: 1.25rem;
        }
        .p-4 {
          padding: 0.75rem;
        }
        .p-2 {
          padding: 0.375rem;
        }
        .py-3 {
          padding-top: 0.5rem;
          padding-bottom: 0.5rem;
        }
        .grid-cols-2 {
          grid-template-columns: 1fr;
        }
        .table-responsive {
          display: block;
          width: 100%;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }
        table {
          min-width: 100%;
        }
        th,
        td {
          font-size: 0.875rem;
          padding: 0.5rem;
        }
        button,
        input,
        select {
          font-size: 1rem;
          padding: 0.75rem;
          min-height: 44px;
          touch-action: manipulation;
        }
        button {
          line-height: 1.25;
        }
        .min-w-\[2rem\] {
          min-width: 44px;
        }
      }

      @media (max-width: 480px) {
        .text-3xl {
          font-size: 1.25rem;
        }
        .text-2xl {
          font-size: 1.125rem;
        }
        .text-xl {
          font-size: 0.875rem;
        }
        input,
        select {
          font-size: 0.875rem;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4">
      <h1 class="text-3xl font-bold text-center mb-6">
        INVOICE MANAGEMENT SYSTEM
      </h1>

      <!-- Dashboard -->
      <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <h2 class="text-2xl font-semibold mb-4">Dashboard</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p>
              <strong>Total Projects:</strong> <span id="projectCount">0</span>
            </p>
            <p>
              <strong>Total Project Cost:</strong> $<span id="totalProjectCost"
                >0.00</span
              >
            </p>
          </div>
          <div>
            <p>
              <strong>Total Invoices:</strong> <span id="invoiceCount">0</span>
            </p>
            <p>
              <strong>Total Invoiced Amount:</strong> $<span
                id="totalInvoicedAmount"
                >0.00</span
              >
            </p>
          </div>
        </div>
      </div>

      <!-- Item Price Management -->
      <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <h2 class="text-2xl font-semibold mb-4" id="itemPriceFormTitle">
          Manage Item Prices
        </h2>
        <div class="grid grid-cols-1 gap-4">
          <input id="itemPriceId" type="hidden" />
          <input
            id="itemPriceDescription"
            type="text"
            placeholder="Item Description (e.g., Concrete)"
            class="border p-2 rounded w-full"
          />
          <select
            id="itemPricePricingType"
            class="border p-2 rounded w-full min-h-[44px]"
          >
            <option value="Fixed">Fixed Cost</option>
            <option value="Hourly">Hourly Rate</option>
            <option value="Material">Material</option>
          </select>
          <input
            id="itemPriceBaseCost"
            type="number"
            placeholder="Base Cost (per unit or hour)"
            class="border p-2 rounded w-full min-h-[44px]"
          />
          <input
            id="itemPriceCustomer"
            type="text"
            placeholder="Customer Name (leave blank for default)"
            class="border p-2 rounded w-full min-h-[44px]"
          />
          <button
            onclick="saveItemPrice()"
            class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600 w-full min-h-[44px] touch-manipulation"
          >
            Save Item Price
          </button>
        </div>
        <div class="mt-4">
          <h3 class="text-xl font-semibold mb-2">Item Price List</h3>
          <div class="table-responsive">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gray-200">
                  <th class="border p-2">Description</th>
                  <th class="border p-2">Pricing Type</th>
                  <th class="border p-2">Base Cost</th>
                  <th class="border p-2">Customer</th>
                  <th class="border p-2">Actions</th>
                </tr>
              </thead>
              <tbody id="itemPriceTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Project Form -->
      <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <h2 class="text-2xl font-semibold mb-4" id="projectFormTitle">
          Add New Project
        </h2>
        <div class="grid grid-cols-1 gap-4">
          <input id="projectId" type="hidden" />
          <input
            id="projectName"
            type="text"
            placeholder="Project Name"
            class="border p-2 rounded w-full min-h-[44px]"
          />
          <input
            id="clientName"
            type="text"
            placeholder="Client Name"
            class="border p-2 rounded w-full min-h-[44px]"
          />
          <input
            id="projectManager"
            type="text"
            placeholder="Project Manager"
            class="border p-2 rounded w-full min-h-[44px]"
          />
          <select
            id="projectStatus"
            class="border p-2 rounded w-full min-h-[44px]"
          >
            <option value="Not Started">Not Started</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
          </select>
          <button
            onclick="saveProject()"
            class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600 w-full min-h-[44px] touch-manipulation"
          >
            Save Project
          </button>
        </div>
      </div>

      <!-- Project Item Form -->
      <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <h2 class="text-2xl font-semibold mb-4" id="itemFormTitle">
          Add Item to Project
        </h2>
        <div class="grid grid-cols-1 gap-4">
          <input id="itemId" type="hidden" />
          <select
            id="itemProject"
            class="border p-2 rounded w-full min-h-[44px]"
            onchange="updateItemDescriptionSelect()"
          >
            <option value="">Select Project</option>
          </select>
          <select
            id="itemDescription"
            class="border p-2 rounded w-full min-h-[44px]"
            onchange="updateItemCost()"
          >
            <option value="">Select Item Description</option>
          </select>
          <select
            id="itemPricingType"
            class="border p-2 rounded w-full min-h-[44px]"
          >
            <option value="Fixed">Fixed Cost</option>
            <option value="Hourly">Hourly Rate</option>
            <option value="Material">Material</option>
          </select>
          <input
            id="itemCost"
            type="number"
            placeholder="Cost (per unit or hour)"
            class="border p-2 rounded w-full min-h-[44px]"
          />
          <input
            id="itemQuantity"
            type="number"
            placeholder="Quantity (e.g., units or hours)"
            class="border p-2 rounded w-full min-h-[44px]"
            value="1"
          />
          <button
            onclick="saveProjectItem()"
            class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600 w-full min-h-[44px] touch-manipulation"
          >
            Save Item
          </button>
        </div>
      </div>

      <!-- Project List -->
      <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <h2 class="text-2xl font-semibold mb-4">Projects</h2>
        <div class="table-responsive">
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-gray-200">
                <th class="border p-2">Project Name</th>
                <th class="border p-2">Client Name</th>
                <th class="border p-2">Project Manager</th>
                <th class="border p-2">Total Cost</th>
                <th class="border p-2">Status</th>
                <th class="border p-2">Items</th>
                <th class="border p-2">Actions</th>
              </tr>
            </thead>
            <tbody id="projectTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Invoice Generator -->
      <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <h2 class="text-2xl font-semibold mb-4" id="invoiceFormTitle">
          Generate Invoice
        </h2>
        <div class="grid grid-cols-1 gap-4">
          <input id="invoiceId" type="hidden" />
          <select
            id="invoiceProject"
            class="border p-2 rounded w-full min-h-[44px]"
            onchange="updateInvoiceItemSelect()"
          >
            <option value="">Select Project</option>
          </select>
          <div id="invoiceItems" class="grid grid-cols-1 gap-2"></div>
          <input
            id="taxRate"
            type="number"
            placeholder="Tax Rate (%)"
            class="border p-2 rounded w-full min-h-[44px]"
            value="0"
          />
          <input
            id="discount"
            type="number"
            placeholder="Discount (%)"
            class="border p-2 rounded w-full min-h-[44px]"
            value="0"
          />
          <button
            onclick="saveInvoice()"
            class="bg-green-500 text-white py-3 px-4 rounded hover:bg-green-600 w-full min-h-[44px] touch-manipulation"
          >
            Save Invoice
          </button>
        </div>
        <div id="invoiceOutput" class="mt-4"></div>
      </div>

      <!-- Invoice List -->
      <div class="bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4">Invoices</h2>
        <div class="table-responsive">
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-gray-200">
                <th class="border p-2">Invoice ID</th>
                <th class="border p-2">Project</th>
                <th class="border p-2">Client</th>
                <th class="border p-2">Project Manager</th>
                <th class="border p-2">Total</th>
                <th class="border p-2">Date</th>
                <th class="border p-2">Actions</th>
              </tr>
            </thead>
            <tbody id="invoiceTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      let projects = JSON.parse(localStorage.getItem("projects")) || [];
      let invoices = JSON.parse(localStorage.getItem("invoices")) || [];
      let itemPrices = [];
      const { jsPDF } = window.jspdf;
      const API_BASE_URL = "https://will-invoice.onrender.com"; // Adjust to your server URL

      async function fetchItemPrices() {
        try {
          const response = await fetch(`${API_BASE_URL}/item-prices`);
          if (!response.ok)
            throw new Error(`HTTP error! Status: ${response.status}`);
          itemPrices = await response.json();
          updateItemPriceTable();
          updateItemDescriptionSelect();
        } catch (error) {
          console.error("Error fetching item prices:", error);
          alert("Failed to fetch item prices. Please try again.");
        }
      }

      async function saveItemPrice() {
        const itemPriceId = document.getElementById("itemPriceId").value;
        const description = document.getElementById(
          "itemPriceDescription"
        ).value;
        const pricingType = document.getElementById(
          "itemPricePricingType"
        ).value;
        const baseCost = parseFloat(
          document.getElementById("itemPriceBaseCost").value
        );
        const customer =
          document.getElementById("itemPriceCustomer").value || "Default";

        if (description && baseCost >= 0) {
          const itemPrice = {
            id: itemPriceId ? parseInt(itemPriceId) : Date.now(),
            description,
            pricingType,
            baseCost,
            customer,
          };
          try {
            const url = itemPriceId
              ? `${API_BASE_URL}/item-prices/${itemPriceId}`
              : `${API_BASE_URL}/item-prices`;
            const method = itemPriceId ? "PUT" : "POST";
            const response = await fetch(url, {
              method,
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(itemPrice),
            });
            if (!response.ok)
              throw new Error(`HTTP error! Status: ${response.status}`);
            await fetchItemPrices();
            clearItemPriceForm();
          } catch (error) {
            console.error(
              `Error ${itemPriceId ? "updating" : "creating"} item price:`,
              error
            );
            alert(
              `Failed to ${
                itemPriceId ? "update" : "create"
              } item price. Please try again.`
            );
          }
        } else {
          alert(
            "Please fill in all required fields (Description and Base Cost)"
          );
        }
      }

      async function editItemPrice(id) {
        const itemPrice = itemPrices.find((ip) => ip.id === id);
        document.getElementById("itemPriceId").value = itemPrice.id;
        document.getElementById("itemPriceDescription").value =
          itemPrice.description;
        document.getElementById("itemPricePricingType").value =
          itemPrice.pricingType;
        document.getElementById("itemPriceBaseCost").value = itemPrice.baseCost;
        document.getElementById("itemPriceCustomer").value =
          itemPrice.customer === "Default" ? "" : itemPrice.customer;
        document.getElementById("itemPriceFormTitle").textContent =
          "Edit Item Price";
      }

      async function deleteItemPrice(id) {
        if (confirm("Are you sure you want to delete this item price?")) {
          try {
            const response = await fetch(`${API_BASE_URL}/item-prices/${id}`, {
              method: "DELETE",
            });
            if (!response.ok)
              throw new Error(`HTTP error! Status: ${response.status}`);
            await fetchItemPrices();
          } catch (error) {
            console.error("Error deleting item price:", error);
            alert("Failed to delete item price. Please try again.");
          }
        }
      }

      function updateItemPriceTable() {
        const tableBody = document.getElementById("itemPriceTableBody");
        tableBody.innerHTML = "";
        itemPrices.forEach((itemPrice) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="border p-2">${itemPrice.description}</td>
            <td class="border p-2">${itemPrice.pricingType}</td>
            <td class="border p-2">$${parseFloat(itemPrice.baseCost).toFixed(
              2
            )}</td>
            <td class="border p-2">${itemPrice.customer}</td>
            <td class="border p-2 flex flex-col gap-2">
              <button onclick="editItemPrice(${
                itemPrice.id
              })" ontouchstart="editItemPrice(${
            itemPrice.id
          })" class="bg-yellow-500 text-white py-1 px-2 rounded hover:bg-yellow-600 w-full min-h-[44px] touch-manipulation">Edit</button>
              <button onclick="deleteItemPrice(${
                itemPrice.id
              })" ontouchstart="deleteItemPrice(${
            itemPrice.id
          })" class="bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600 w-full min-h-[44px] touch-manipulation">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      function saveProject() {
        const projectId = document.getElementById("projectId").value;
        const projectName = document.getElementById("projectName").value;
        const clientName = document.getElementById("clientName").value;
        const projectManager = document.getElementById("projectManager").value;
        const projectStatus = document.getElementById("projectStatus").value;

        if (projectName && clientName) {
          if (projectId) {
            const project = projects.find((p) => p.id === parseInt(projectId));
            project.name = projectName;
            project.client = clientName;
            project.manager = projectManager || "Unassigned";
            project.status = projectStatus;
          } else {
            const project = {
              id: Date.now(),
              name: projectName,
              client: clientName,
              manager: projectManager || "Unassigned",
              status: projectStatus,
              items: [],
            };
            projects.push(project);
          }
          localStorage.setItem("projects", JSON.stringify(projects));
          updateProjectTable();
          updateSelects();
          clearProjectForm();
        } else {
          alert(
            "Please fill in all required fields (Project Name and Client Name)"
          );
        }
      }

      function editProject(id) {
        const project = projects.find((p) => p.id === id);
        document.getElementById("projectId").value = project.id;
        document.getElementById("projectName").value = project.name;
        document.getElementById("clientName").value = project.client;
        document.getElementById("projectManager").value = project.manager || "";
        document.getElementById("projectStatus").value = project.status;
        document.getElementById("projectFormTitle").textContent =
          "Edit Project";
      }

      function updateItemDescriptionSelect() {
        const projectId = document.getElementById("itemProject").value;
        const itemDescriptionSelect =
          document.getElementById("itemDescription");
        itemDescriptionSelect.innerHTML =
          '<option value="">Select Item Description</option>';
        if (projectId) {
          const project = projects.find((p) => p.id === parseInt(projectId));
          const clientName = project.client;
          const relevantPrices = itemPrices.filter(
            (ip) => ip.customer === "Default" || ip.customer === clientName
          );
          relevantPrices.forEach((itemPrice) => {
            const option = document.createElement("option");
            option.value = itemPrice.description;
            option.textContent = `${itemPrice.description} (${
              itemPrice.pricingType
            }, $${parseFloat(itemPrice.baseCost).toFixed(2)} for ${
              itemPrice.customer
            })`;
            itemDescriptionSelect.appendChild(option);
          });
        }
        updateItemCost();
      }

      function updateItemCost() {
        const projectId = document.getElementById("itemProject").value;
        const description = document.getElementById("itemDescription").value;
        const itemCostInput = document.getElementById("itemCost");
        const pricingTypeSelect = document.getElementById("itemPricingType");
        if (projectId && description) {
          const project = projects.find((p) => p.id === parseInt(projectId));
          const clientName = project.client;
          const itemPrice = itemPrices.find(
            (ip) =>
              ip.description === description &&
              (ip.customer === clientName || ip.customer === "Default")
          );
          if (itemPrice) {
            itemCostInput.value = parseFloat(itemPrice.baseCost).toFixed(2);
            pricingTypeSelect.value = itemPrice.pricingType;
          } else {
            itemCostInput.value = "";
            pricingTypeSelect.value = "Fixed";
          }
        } else {
          itemCostInput.value = "";
          pricingTypeSelect.value = "Fixed";
        }
      }

      function saveProjectItem() {
        const itemId = document.getElementById("itemId").value;
        const projectId = document.getElementById("itemProject").value;
        const description = document.getElementById("itemDescription").value;
        const pricingType = document.getElementById("itemPricingType").value;
        const cost = parseFloat(document.getElementById("itemCost").value);
        const quantity = parseInt(
          document.getElementById("itemQuantity").value
        );

        if (projectId && description && cost >= 0 && quantity > 0) {
          const project = projects.find((p) => p.id === parseInt(projectId));
          if (itemId) {
            const item = project.items.find((i) => i.id === parseInt(itemId));
            item.description = description;
            item.pricingType = pricingType;
            item.cost = cost;
            item.quantity = quantity;
            item.total = cost * quantity;
          } else {
            project.items.push({
              id: Date.now(),
              description,
              pricingType,
              cost,
              quantity,
              total: cost * quantity,
            });
          }
          localStorage.setItem("projects", JSON.stringify(projects));
          updateProjectTable();
          updateInvoiceItemSelect();
          clearItemForm();
        } else {
          alert("Please fill in all item fields and select a project");
        }
      }

      function editProjectItem(projectId, itemId) {
        const project = projects.find((p) => p.id === projectId);
        const item = project.items.find((i) => i.id === itemId);
        document.getElementById("itemId").value = item.id;
        document.getElementById("itemProject").value = project.id;
        document.getElementById("itemDescription").value = item.description;
        document.getElementById("itemPricingType").value = item.pricingType;
        document.getElementById("itemCost").value = item.cost;
        document.getElementById("itemQuantity").value = item.quantity;
        document.getElementById("itemFormTitle").textContent = "Edit Item";
        updateItemDescriptionSelect();
      }

      function deleteProjectItem(projectId, itemId) {
        if (confirm("Are you sure you want to delete this item?")) {
          const project = projects.find((p) => p.id === projectId);
          project.items = project.items.filter((item) => item.id !== itemId);
          localStorage.setItem("projects", JSON.stringify(projects));
          updateProjectTable();
          updateInvoiceItemSelect();
        }
      }

      function updateProjectTable() {
        const tableBody = document.getElementById("projectTableBody");
        tableBody.innerHTML = "";
        projects.forEach((project) => {
          const totalCost = project.items.reduce(
            (sum, item) => sum + item.total,
            0
          );
          const projectInvoices = invoices.filter(
            (invoice) => invoice.projectId === project.id
          );
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="border p-2">${project.name}</td>
            <td class="border p-2">${project.client}</td>
            <td class="border p-2">${project.manager || "Unassigned"}</td>
            <td class="border p-2">$${totalCost.toFixed(2)}</td>
            <td class="border p-2">${project.status}</td>
            <td class="border p-2">
              ${project.items
                .map(
                  (item) => `
                <div class="flex items-center justify-between">
                  <span class="text-base">${item.description} (${
                    item.pricingType
                  }): $${item.cost.toFixed(2)} x ${
                    item.quantity
                  } = $${item.total.toFixed(2)}</span>
                  <div>
                    <button onclick="editProjectItem(${project.id}, ${
                    item.id
                  })" ontouchstart="editProjectItem(${project.id}, ${
                    item.id
                  })" class="bg-yellow-500 text-white p-1 rounded hover:bg-yellow-600 ml-2 min-w-[44px] min-h-[44px] touch-manipulation">Edit</button>
                    <button onclick="deleteProjectItem(${project.id}, ${
                    item.id
                  })" ontouchstart="deleteProjectItem(${project.id}, ${
                    item.id
                  })" class="bg-red-500 text-white p-1 rounded hover:bg-red-600 ml-2 min-w-[44px] min-h-[44px] touch-manipulation">Delete</button>
                  </div>
                </div>
              `
                )
                .join("")}
            </td>
            <td class="border p-2 flex flex-col gap-2">
              <button onclick="editProject(${
                project.id
              })" ontouchstart="editProject(${
            project.id
          })" class="bg-yellow-500 text-white py-1 px-2 rounded hover:bg-yellow-600 w-full min-h-[44px] touch-manipulation">Edit</button>
              <button onclick="deleteProject(${
                project.id
              })" ontouchstart="deleteProject(${
            project.id
          })" class="bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600 w-full min-h-[44px] touch-manipulation">Delete</button>
              ${projectInvoices
                .map(
                  (invoice) => `
                <button onclick="downloadInvoice(${invoice.id})" ontouchstart="downloadInvoice(${invoice.id})" class="bg-blue-500 text-white py-1 px-2 rounded hover:bg-blue-600 w-full min-h-[44px] touch-manipulation">Download PDF #${invoice.id}</button>
                <button onclick="promptSendInvoice(${invoice.id})" ontouchstart="promptSendInvoice(${invoice.id})" class="bg-green-500 text-white py-1 px-2 rounded hover:bg-green-600 w-full min-h-[44px] touch-manipulation">Send Invoice #${invoice.id}</button>
              `
                )
                .join("")}
            </td>
          `;
          tableBody.appendChild(row);
        });
        updateDashboard();
      }

      function deleteProject(id) {
        if (
          confirm(
            "Are you sure you want to delete this project and its associated invoices?"
          )
        ) {
          projects = projects.filter((project) => project.id !== id);
          invoices = invoices.filter((invoice) => invoice.projectId !== id);
          localStorage.setItem("projects", JSON.stringify(projects));
          localStorage.setItem("invoices", JSON.stringify(invoices));
          updateProjectTable();
          updateInvoiceTable();
          updateSelects();
        }
      }

      function updateSelects() {
        const itemSelect = document.getElementById("itemProject");
        const invoiceSelect = document.getElementById("invoiceProject");
        itemSelect.innerHTML = '<option value="">Select Project</option>';
        invoiceSelect.innerHTML = '<option value="">Select Project</option>';
        projects.forEach((project) => {
          const option1 = document.createElement("option");
          const option2 = document.createElement("option");
          option1.value = project.id;
          option1.textContent = `${project.name} - ${project.client}`;
          option2.value = project.id;
          option2.textContent = `${project.name} - ${project.client}`;
          itemSelect.appendChild(option1);
          invoiceSelect.appendChild(option2);
        });
        updateItemDescriptionSelect();
        updateInvoiceItemSelect();
      }

      function updateInvoiceItemSelect() {
        const projectId = document.getElementById("invoiceProject").value;
        const invoiceItemsDiv = document.getElementById("invoiceItems");
        invoiceItemsDiv.innerHTML = "";
        if (projectId) {
          const project = projects.find((p) => p.id === parseInt(projectId));
          project.items.forEach((item) => {
            const div = document.createElement("div");
            div.innerHTML = `
              <label class="flex items-center">
                <input type="checkbox" value="${
                  item.id
                }" class="invoice-item-checkbox mr-2 min-h-[44px]">
                ${item.description} (${item.pricingType}): $${item.cost.toFixed(
              2
            )} x ${item.quantity} = $${item.total.toFixed(2)}
              </label>
            `;
            invoiceItemsDiv.appendChild(div);
          });
        }
      }

      function saveInvoice() {
        const invoiceId = document.getElementById("invoiceId").value;
        const projectId = document.getElementById("invoiceProject").value;
        const taxRate =
          parseFloat(document.getElementById("taxRate").value) || 0;
        const discount =
          parseFloat(document.getElementById("discount").value) || 0;
        const selectedItems = Array.from(
          document.querySelectorAll(".invoice-item-checkbox:checked")
        ).map((cb) => parseInt(cb.value));
        const invoiceOutput = document.getElementById("invoiceOutput");

        if (!projectId || selectedItems.length === 0) {
          invoiceOutput.innerHTML =
            '<p class="text-red-500">Please select a project and at least one item.</p>';
          return;
        }

        const project = projects.find((p) => p.id === parseInt(projectId));
        const invoiceItems = project.items.filter((item) =>
          selectedItems.includes(item.id)
        );
        const subtotal = invoiceItems.reduce(
          (sum, item) => sum + item.total,
          0
        );
        const taxAmount = subtotal * (taxRate / 100);
        const discountAmount = subtotal * (discount / 100);
        const totalAmount = subtotal + taxAmount - discountAmount;
        const invoiceDate = new Date().toLocaleDateString();

        const invoice = {
          id: invoiceId ? parseInt(invoiceId) : Date.now(),
          projectId: parseInt(projectId),
          items: invoiceItems,
          taxRate,
          discount,
          subtotal,
          taxAmount,
          discountAmount,
          totalAmount,
          date: invoiceDate,
        };

        if (invoiceId) {
          const index = invoices.findIndex(
            (inv) => inv.id === parseInt(invoiceId)
          );
          invoices[index] = invoice;
        } else {
          invoices.push(invoice);
        }

        localStorage.setItem("invoices", JSON.stringify(invoices));
        updateInvoiceTable();
        updateProjectTable();
        renderInvoice(invoice);
        clearInvoiceForm();
      }

      function editInvoice(id) {
        const invoice = invoices.find((inv) => inv.id === id);
        const project = projects.find((p) => p.id === invoice.projectId);
        document.getElementById("invoiceId").value = invoice.id;
        document.getElementById("invoiceProject").value = invoice.projectId;
        document.getElementById("taxRate").value = invoice.taxRate;
        document.getElementById("discount").value = invoice.discount;
        document.getElementById("invoiceFormTitle").textContent =
          "Edit Invoice";
        updateInvoiceItemSelect();
        const checkboxes = document.querySelectorAll(".invoice-item-checkbox");
        checkboxes.forEach((cb) => {
          if (invoice.items.some((item) => item.id === parseInt(cb.value))) {
            cb.checked = true;
          }
        });
        renderInvoice(invoice);
      }

      function renderInvoice(invoice) {
        const invoiceOutput = document.getElementById("invoiceOutput");
        const project = projects.find((p) => p.id === invoice.projectId);
        invoiceOutput.innerHTML = `
          <div class="border p-4 rounded bg-gray-50">
            <h3 class="text-xl font-bold mb-2">Invoice #${invoice.id}</h3>
            <p><strong>Project:</strong> ${project.name}</p>
            <p><strong>Client:</strong> ${project.client}</p>
            <p><strong>Project Manager:</strong> ${
              project.manager || "Unassigned"
            }</p>
            <p><strong>Date:</strong> ${invoice.date}</p>
            <h4 class="font-semibold mt-2">Items:</h4>
            <ul class="list-disc pl-5">
              ${invoice.items
                .map(
                  (item) => `
                <li>${item.description} (${
                    item.pricingType
                  }): $${item.cost.toFixed(2)} x ${
                    item.quantity
                  } = $${item.total.toFixed(2)}</li>
              `
                )
                .join("")}
            </ul>
            <p class="mt-2"><strong>Subtotal:</strong> $${invoice.subtotal.toFixed(
              2
            )}</p>
            <p><strong>Tax (${
              invoice.taxRate
            }%):</strong> $${invoice.taxAmount.toFixed(2)}</p>
            <p><strong>Discount (${
              invoice.discount
            }%):</strong> -$${invoice.discountAmount.toFixed(2)}</p>
            <p class="font-bold"><strong>Total:</strong> $${invoice.totalAmount.toFixed(
              2
            )}</p>
            <div class="flex flex-col gap-2 mt-4">
              <button onclick="downloadInvoice(${
                invoice.id
              })" ontouchstart="downloadInvoice(${
          invoice.id
        })" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 min-h-[44px] touch-manipulation">Download PDF Invoice</button>
              <button onclick="promptSendInvoice(${
                invoice.id
              })" ontouchstart="promptSendInvoice(${
          invoice.id
        })" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 min-h-[44px] touch-manipulation">Send Invoice</button>
            </div>
          </div>
        `;
      }

      function updateInvoiceTable() {
        const tableBody = document.getElementById("invoiceTableBody");
        tableBody.innerHTML = "";
        invoices.forEach((invoice) => {
          const project = projects.find((p) => p.id === invoice.projectId);
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="border p-2">${invoice.id}</td>
            <td class="border p-2">${project ? project.name : "N/A"}</td>
            <td class="border p-2">${project ? project.client : "N/A"}</td>
            <td class="border p-2">${
              project ? project.manager || "Unassigned" : "N/A"
            }</td>
            <td class="border p-2">$${invoice.totalAmount.toFixed(2)}</td>
            <td class="border p-2">${invoice.date}</td>
            <td class="border p-2 flex flex-col gap-2">
              <button onclick="editInvoice(${
                invoice.id
              })" ontouchstart="editInvoice(${
            invoice.id
          })" class="bg-yellow-500 text-white py-1 px-2 rounded hover:bg-yellow-600 w-full min-h-[44px] touch-manipulation">Edit</button>
              <button onclick="deleteInvoice(${
                invoice.id
              })" ontouchstart="deleteInvoice(${
            invoice.id
          })" class="bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600 w-full min-h-[44px] touch-manipulation">Delete</button>
              <button onclick="downloadInvoice(${
                invoice.id
              })" ontouchstart="downloadInvoice(${
            invoice.id
          })" class="bg-blue-500 text-white py-1 px-2 rounded hover:bg-blue-600 w-full min-h-[44px] touch-manipulation">Download PDF</button>
              <button onclick="promptSendInvoice(${
                invoice.id
              })" ontouchstart="promptSendInvoice(${
            invoice.id
          })" class="bg-green-500 text-white py-1 px-2 rounded hover:bg-green-600 w-full min-h-[44px] touch-manipulation">Send</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
        updateDashboard();
      }

      function deleteInvoice(id) {
        if (confirm("Are you sure you want to delete this invoice?")) {
          invoices = invoices.filter((invoice) => invoice.id !== id);
          localStorage.setItem("invoices", JSON.stringify(invoices));
          updateInvoiceTable();
          updateProjectTable();
          document.getElementById("invoiceOutput").innerHTML = "";
        }
      }

      function generateInvoicePDF(invoiceId) {
        const invoice = invoices.find((inv) => inv.id === invoiceId);
        const project = projects.find((p) => p.id === invoice.projectId);
        const doc = new jsPDF();
        const margin = 10;
        let y = 20;

        doc.setFontSize(16);
        doc.text(`Construction Project Invoice #${invoice.id}`, margin, y);
        y += 10;
        doc.setLineWidth(0.5);
        doc.line(margin, y, 200, y);
        y += 10;

        doc.setFontSize(12);
        doc.text(`Project: ${project.name}`, margin, y);
        y += 7;
        doc.text(`Client: ${project.client}`, margin, y);
        y += 7;
        doc.text(
          `Project Manager: ${project.manager || "Unassigned"}`,
          margin,
          y
        );
        y += 7;
        doc.text(`Date: ${invoice.date}`, margin, y);
        y += 10;

        doc.setFontSize(14);
        doc.text("Items:", margin, y);
        y += 7;

        doc.setFontSize(10);
        invoice.items.forEach((item) => {
          const itemText = `${item.description} (${
            item.pricingType
          }): $${item.cost.toFixed(2)} x ${
            item.quantity
          } = $${item.total.toFixed(2)}`;
          const splitText = doc.splitTextToSize(itemText, 180);
          doc.text(splitText, margin, y);
          y += splitText.length * 5;
        });
        y += 5;

        doc.setLineWidth(0.5);
        doc.line(margin, y, 200, y);
        y += 7;
        doc.text(`Subtotal: $${invoice.subtotal.toFixed(2)}`, margin, y);
        y += 7;
        doc.text(
          `Tax (${invoice.taxRate}%): $${invoice.taxAmount.toFixed(2)}`,
          margin,
          y
        );
        y += 7;
        doc.text(
          `Discount (${invoice.discount}%): -$${invoice.discountAmount.toFixed(
            2
          )}`,
          margin,
          y
        );
        y += 7;
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text(`Total: $${invoice.totalAmount.toFixed(2)}`, margin, y);
        y += 10;

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("Thank you for your business!", margin, y);

        return doc;
      }

      function downloadInvoice(invoiceId) {
        const doc = generateInvoicePDF(invoiceId);
        const project = projects.find(
          (p) => p.id === invoices.find((inv) => inv.id === invoiceId).projectId
        );
        doc.save(
          `Invoice_${project.name}_${
            invoices.find((inv) => inv.id === invoiceId).date
          }.pdf`
        );
      }

      async function promptSendInvoice(invoiceId) {
        const recipientEmail = prompt("Enter the recipient email address:");
        if (
          recipientEmail &&
          /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(recipientEmail)
        ) {
          await sendInvoice(invoiceId, recipientEmail);
        } else {
          alert("Please enter a valid email address.");
        }
      }

      async function sendInvoice(invoiceId, recipientEmail) {
        const invoice = invoices.find((inv) => inv.id === invoiceId);
        const project = projects.find((p) => p.id === invoice.projectId);
        const doc = generateInvoicePDF(invoiceId);
        const pdfBase64 = doc.output("datauristring").split(",")[1];

        try {
          const response = await fetch(`${API_BASE_URL}/send-email`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              invoiceId,
              projectName: project.name,
              recipientEmail,
              pdfBase64,
            }),
          });
          const result = await response.json();
          if (response.ok) {
            alert(
              `Invoice #${invoiceId} sent successfully to ${recipientEmail}!`
            );
          } else {
            alert(`Failed to send invoice: ${result.error}`);
          }
        } catch (error) {
          alert(`Error sending invoice: ${error.message}`);
        }
      }

      function updateDashboard() {
        const projectCount = projects.length;
        const totalProjectCost = projects.reduce(
          (sum, project) =>
            sum + project.items.reduce((sum, item) => sum + item.total, 0),
          0
        );
        const invoiceCount = invoices.length;
        const totalInvoicedAmount = invoices.reduce(
          (sum, invoice) => sum + invoice.totalAmount,
          0
        );

        document.getElementById("projectCount").textContent = projectCount;
        document.getElementById("totalProjectCost").textContent =
          totalProjectCost.toFixed(2);
        document.getElementById("invoiceCount").textContent = invoiceCount;
        document.getElementById("totalInvoicedAmount").textContent =
          totalInvoicedAmount.toFixed(2);
      }

      function clearItemPriceForm() {
        document.getElementById("itemPriceId").value = "";
        document.getElementById("itemPriceDescription").value = "";
        document.getElementById("itemPricePricingType").value = "Fixed";
        document.getElementById("itemPriceBaseCost").value = "";
        document.getElementById("itemPriceCustomer").value = "";
        document.getElementById("itemPriceFormTitle").textContent =
          "Manage Item Prices";
      }

      function clearProjectForm() {
        document.getElementById("projectId").value = "";
        document.getElementById("projectName").value = "";
        document.getElementById("clientName").value = "";
        document.getElementById("projectManager").value = "";
        document.getElementById("projectStatus").value = "Not Started";
        document.getElementById("projectFormTitle").textContent =
          "Add New Project";
      }

      function clearItemForm() {
        document.getElementById("itemId").value = "";
        document.getElementById("itemProject").value = "";
        document.getElementById("itemDescription").value = "";
        document.getElementById("itemCost").value = "";
        document.getElementById("itemQuantity").value = "1";
        document.getElementById("itemPricingType").value = "Fixed";
        document.getElementById("itemFormTitle").textContent =
          "Add Item to Project";
      }

      function clearInvoiceForm() {
        document.getElementById("invoiceId").value = "";
        document.getElementById("invoiceProject").value = "";
        document.getElementById("taxRate").value = "0";
        document.getElementById("discount").value = "0";
        document.getElementById("invoiceFormTitle").textContent =
          "Generate Invoice";
        document.getElementById("invoiceItems").innerHTML = "";
        document.getElementById("invoiceOutput").innerHTML = "";
      }

      // Initialize
      fetchItemPrices();
      updateProjectTable();
      updateInvoiceTable();
      updateSelects();
    </script>
  </body>
</html>
